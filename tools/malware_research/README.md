<img width="1440" alt="Elastic Security Labs Banner Image" src="https://user-images.githubusercontent.com/7442091/234121634-fd2518cf-70cb-4eee-8134-393c1f712bac.png">

## An Elastic approach to large-scale dynamic malware analysis
This repository contains the Python snippets leveraged for creating gsub json objects, custom pipeline configurations and setting up and executing enrich policies as described in our research publication [An Elastic approach to large-scale dynamic malware analysis](https://elastic.co/security-labs/an-elastic-approach-to-large-scale-dynamic-malware-analysis).

## Requirements
The only requirement for running the Python scripts is the installation of the Python `Requests` module. This module can be installed via the `requirements.txt` or by just running `pip install requests`

## gsub_pipeline_json_object.py
This script parses the fields and patterns inserted into the `FIELDS` and `PATTERNS` lists within the `gsub_pipeline_json_object.py` file, and creates a json object that can be used as input for the gsub pipeline.

## custom_pipeline.py
This script requests the different custom pipeline processors by sending `GET` requests to Elasticsearch and look for pipeline processors with a file name ending with `@custom`. It then creates a new ingest pipeline for each `@custom` pipeline found. Make sure to supply a valid `APIKEY` and `CLUSTER_URL` for this script to work.

## enrich_policy_setup.py
This script is used to set up the necessary enrich policies and execute these policies without having to run these commands manually in the Kibana dev tools. Make sure to supply your own `APIKEY` and `CLUSTER_URL` to make a successful connection. Additionally, this script requires the following custom configuration:

`ENRICH_POLICYS` --> The name of the enrich policy, its index filter and the dataset it uses.

`LABEL_PIPELINE` --> The name of the pipeline that performs the labeling.

`ENRICH_QUERY` --> The desired queries to use for creating the enrich policies.

`INGEST_PIPELINE_CONTENT` --> The content of the enrich pipeline, can be copied from Kibana by looking at the json contents of the ingest pipeline.

After setting these values, the script can be ran to automate the process of setting up the enrich policies. 
