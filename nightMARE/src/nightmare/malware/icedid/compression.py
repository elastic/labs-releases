# coding: utf-8

import typing
import ctypes

COMPRESSION_FORMAT_LZNT1 = 2
STATUS_SUCCESS = 0
STATUS_BAD_COMPRESSION_BUFFER = 0xC0000242


def __decompress_lznt1(
    compressed_data: bytes, decompressed_size: int
) -> typing.Optional[bytes]:
    ntdll = ctypes.windll.LoadLibrary("ntdll.dll")

    decompressed_data = ctypes.c_buffer(decompressed_size)
    n_bytes = ctypes.c_uint32(0)

    result = ctypes.c_uint32(
        ntdll.RtlDecompressBuffer(
            COMPRESSION_FORMAT_LZNT1,
            decompressed_data,
            decompressed_size,
            compressed_data,
            len(compressed_data),
            ctypes.byref(n_bytes),
        )
    ).value

    return None if STATUS_SUCCESS != result else decompressed_data.raw


def decompress(data: bytes) -> typing.Optional[bytes]:
    """
    The function decompress ICEDID's compressed data using LZNT1 algorithm
    :param data: ICEDID's compressed data
    :return: Decompressed data if successful else None
    """

    return __decompress_lznt1(data[4:], int.from_bytes(data[:4], "little"))
